<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/bundle.css">
    <title>ZigRadio</title>
  </head>
  <body>
    <div class="container">
      <div class="sidebar">
        <h1 class="title" id="zigradio"><a href="/">ZigRadio</a></h1>
        <div class="links">
          <a href="https://github.com/vsergeev/zigradio/blob/master/CHANGELOG.md"><span class="lucide--external-link icon"></span> <code class="version">v0.9.0</code></a><br>
          <a href="https://github.com/vsergeev/zigradio"><span class="mdi--github icon"></span> GitHub</a><br>
        </div>
        <div class="toc"><ul>
<li><a href="/getting-started.html">Getting Started</a></li>
<li><a href="/creating-flow-graphs.html">Creating Flow Graphs</a></li>
<li><a href="/creating-blocks.html">Creating Blocks</a></li>
<li><a href="/integrating-zigradio.html">Integrating ZigRadio</a></li>
<li><a href="/reference-manual.html">Reference Manual</a></li>
<li><a href="/examples/">Examples</a>
<ul>
<li><a href="/examples/play-tone.html">Play Tone</a></li>
<li><a href="/examples/rtlsdr-wbfm-mono.html">WBFM Mono</a></li>
<li><a href="/examples/rtlsdr-wbfm-stereo.html">WBFM Stereo</a></li>
<li><a href="/examples/rtlsdr-nbfm.html">NBFM</a></li>
<li><a href="/examples/rtlsdr-am-envelope.html">AM (Envelope)</a></li>
<li><a href="/examples/rtlsdr-am-synchronous.html">AM (Synchronous)</a></li>
<li><a href="/examples/rtlsdr-ssb.html">SSB</a></li>
<li><a href="/examples/iqfile-converter.html">IQ File Converter</a></li>
</ul>
</li>
</ul>
</div>
        <a class="contact" href="mailto:v@sergeev.io"><span class="lucide--mail icon"></span> v@sergeev.io</a>
      </div>
      <div>
        <h1 id="integrating-zigradio">Integrating ZigRadio</h1>
<p>ZigRadio is available as a Zig package that can be compiled directly into host
applications. Its only dependencies are an execution environment that supports
multi-threading and the C library for dynamic library loading.</p>
<p>ZigRadio dynamically loads optional acceleration and I/O libraries at runtime.
Host applications do not need to link against these — or any libraries outside
of the C library — to integrate ZigRadio.</p>
<p>Blocks in a ZigRadio flow graph run in their own thread, so a flow graph can be
started without blocking the host application. Host applications can then use
the thread-safe
<a href="/reference-manual.html#applicationsource"><code>ApplicationSource(T)</code></a> to push
samples into flow graphs and
<a href="/reference-manual.html#applicationsink"><code>ApplicationSink(T)</code></a> to consume
samples from a flow graph.</p>
<h2 id="application-source">Application Source</h2>
<p>The <code>ApplicationSource(T)</code> can be instantiated for any data type and is
initialized with <code>init(rate: f64) Application(T)</code>. This requires a sample rate,
as it is a source.</p>
<p>The <code>wait(self: *Self, min_count: usize, timeout_ns: ?u64) error{ BrokenStream, Timeout }!void</code> API waits until a minimum number of samples are available
writing, with an optional timeout. The <code>available(self: *Self) error{BrokenStream}!usize</code> API returns the number of samples that can be
written, or a <code>BrokenStream</code> error if the flow graph collapsed downstream.</p>
<p>The low-level <code>get(self: *Self) []T</code> API provides direct access to the write
buffer and <code>update(self: *Self, count: usize) void</code> advances the write buffer
with the number of samples written.</p>
<p>The high-level <code>write(self: *Self, samples: []const T) usize</code> API writes a
slice of samples and returns the number of samples successfully written, which
may be zero.</p>
<p>The high-level <code>push(self: *Self, value: T) error{Unavailable}!void</code> API writes
a single sample, or returns an error if space was not available.</p>
<p>The <code>setEOS(self: *Self) void</code> sets the end-of-stream condition on the source,
which will subsequently collapse the flow graph.</p>
<h2 id="application-sink">Application Sink</h2>
<p>The <code>ApplicationSink(T)</code> can be instantiated for any data type and is
initialized with <code>init() ApplicationSink(T)</code>.</p>
<p>The <code>wait(self: *Self, min_count: usize, timeout_ns: ?u64) error{ EndOfStream, Timeout }!void</code> API waits until a minimum number of samples are available for
reading, with an optional timeout. The <code>available(self: *Self) error{EndOfStream}!usize</code> API returns the number of samples that can be read,
or a <code>EndOfStream</code> error if the flow graph collapsed upstream.</p>
<p>The low-level <code>get(self: *Self) []const T</code> API provides direct access to the
read buffer and <code>update(self: *Self, count: usize) void</code> advances the read
buffer with the number of samples read.</p>
<p>The high-level <code>read(self: *Self, samples: []T) usize</code> API reads into a slice
of samples and returns the number of samples successfully read, which may be
zero.</p>
<p>The high-level <code>pop(self: *Self) ?T</code> API reads a single sample, or returns
<code>null</code> if none was available.</p>
<p>The high-level <code>discard(self: *Self) !void</code> API discards all available samples.</p>
<h2 id="example">Example</h2>
<p>This example creates a flow graph that doubles and then squares samples sourced
from, and then sinked to, an <code>ApplicationSource(f32)</code>, and <code>ApplicationSink(f32)</code>,
respectively.</p>
<pre class="language-zig"><code class="language-zig"><span class="token keyword">const</span> std <span class="token operator">=</span> <span class="token builtin">@import</span><span class="token punctuation">(</span><span class="token string">"std"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> radio <span class="token operator">=</span> <span class="token builtin">@import</span><span class="token punctuation">(</span><span class="token string">"radio"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token class-name"><span class="token operator">!</span><span class="token builtin-type keyword">void</span></span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> gpa <span class="token operator">=</span> std<span class="token punctuation">.</span>heap<span class="token punctuation">.</span><span class="token function">GeneralPurposeAllocator</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">var</span> source <span class="token operator">=</span> radio<span class="token punctuation">.</span>blocks<span class="token punctuation">.</span><span class="token function">ApplicationSource</span><span class="token punctuation">(</span><span class="token builtin-type keyword">f32</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> adder <span class="token operator">=</span> radio<span class="token punctuation">.</span>blocks<span class="token punctuation">.</span><span class="token function">AddBlock</span><span class="token punctuation">(</span><span class="token builtin-type keyword">f32</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> multiplier <span class="token operator">=</span> radio<span class="token punctuation">.</span>blocks<span class="token punctuation">.</span><span class="token function">MultiplyBlock</span><span class="token punctuation">(</span><span class="token builtin-type keyword">f32</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> sink <span class="token operator">=</span> radio<span class="token punctuation">.</span>blocks<span class="token punctuation">.</span><span class="token function">ApplicationSink</span><span class="token punctuation">(</span><span class="token builtin-type keyword">f32</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">var</span> top <span class="token operator">=</span> radio<span class="token punctuation">.</span>Flowgraph<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>gpa<span class="token punctuation">.</span><span class="token function">allocator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">defer</span> top<span class="token punctuation">.</span><span class="token function">deinit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">try</span> top<span class="token punctuation">.</span><span class="token function">connectPort</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>source<span class="token punctuation">.</span>block<span class="token punctuation">,</span> <span class="token string">"out1"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>adder<span class="token punctuation">.</span>block<span class="token punctuation">,</span> <span class="token string">"in1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> top<span class="token punctuation">.</span><span class="token function">connectPort</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>source<span class="token punctuation">.</span>block<span class="token punctuation">,</span> <span class="token string">"out1"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>adder<span class="token punctuation">.</span>block<span class="token punctuation">,</span> <span class="token string">"in2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> top<span class="token punctuation">.</span><span class="token function">connectPort</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>adder<span class="token punctuation">.</span>block<span class="token punctuation">,</span> <span class="token string">"out1"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>multiplier<span class="token punctuation">.</span>block<span class="token punctuation">,</span> <span class="token string">"in1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> top<span class="token punctuation">.</span><span class="token function">connectPort</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>adder<span class="token punctuation">.</span>block<span class="token punctuation">,</span> <span class="token string">"out1"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>multiplier<span class="token punctuation">.</span>block<span class="token punctuation">,</span> <span class="token string">"in2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> top<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>multiplier<span class="token punctuation">.</span>block<span class="token punctuation">,</span> <span class="token operator">&amp;</span>sink<span class="token punctuation">.</span>block<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">try</span> top<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Wait for 3 samples available for writing</span>
    <span class="token keyword">try</span> source<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Write samples 1, 2, 3</span>
    <span class="token keyword">try</span> source<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> source<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> source<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Wait for 3 samples available for reading</span>
    <span class="token keyword">try</span> sink<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Read three samples</span>
    std<span class="token punctuation">.</span>debug<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"{any}\n"</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">{</span>sink<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    std<span class="token punctuation">.</span>debug<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"{any}\n"</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">{</span>sink<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    std<span class="token punctuation">.</span>debug<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"{any}\n"</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">{</span>sink<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Set end-of-stream on source</span>
    source<span class="token punctuation">.</span><span class="token function">setEOS</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Wait for flowgraph collapse</span>
    _ <span class="token operator">=</span> <span class="token keyword">try</span> top<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>Run the example within the ZigRadio source tree with:</p>
<pre class="language-plain"><code class="language-plain">$ zig run -lc --dep radio -Mroot=example.zig -Mradio=src/radio.zig
4
16
36
$</code></pre>

      </div>
    </div>
  </body>
</html>
