<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/bundle.css">
    <title>ZigRadio</title>
  </head>
  <body>
    <div class="container">
      <div class="sidebar">
        <h1 class="title" id="zigradio"><a href="/">ZigRadio</a></h1>
        <div class="links">
          <a href="https://github.com/vsergeev/zigradio/blob/master/CHANGELOG.md"><span class="lucide--external-link icon"></span> <code class="version">v0.9.0</code></a><br>
          <a href="https://github.com/vsergeev/zigradio"><span class="mdi--github icon"></span> GitHub</a><br>
        </div>
        <div class="toc"><ul>
<li><a href="/getting-started.html">Getting Started</a></li>
<li><a href="/creating-flow-graphs.html">Creating Flow Graphs</a></li>
<li><a href="/creating-blocks.html">Creating Blocks</a></li>
<li><a href="/integrating-zigradio.html">Integrating ZigRadio</a></li>
<li><a href="/reference-manual.html">Reference Manual</a></li>
<li><a href="/examples/">Examples</a>
<ul>
<li><a href="/examples/play-tone.html">Play Tone</a></li>
<li><a href="/examples/rtlsdr-wbfm-mono.html">WBFM Mono</a></li>
<li><a href="/examples/rtlsdr-wbfm-stereo.html">WBFM Stereo</a></li>
<li><a href="/examples/rtlsdr-nbfm.html">NBFM</a></li>
<li><a href="/examples/rtlsdr-am-envelope.html">AM (Envelope)</a></li>
<li><a href="/examples/rtlsdr-am-synchronous.html">AM (Synchronous)</a></li>
<li><a href="/examples/rtlsdr-ssb.html">SSB</a></li>
<li><a href="/examples/iqfile-converter.html">IQ File Converter</a></li>
</ul>
</li>
</ul>
</div>
        <a class="contact" href="mailto:v@sergeev.io"><span class="lucide--mail icon"></span> v@sergeev.io</a>
      </div>
      <div>
        <h1 id="creating-blocks">Creating Blocks</h1>
<p>ZigRadio blocks are essentially Zig structures that implement a <code>process()</code>
function to convert input samples to output samples. Additionally, blocks may
implement optional hooks for initialization, deinitialization, and sample rate
manipulation, which are automatically called by the ZigRadio framework during
the setup and teardown of a flow graph.</p>
<p>Blocks may also implement arbitrary functions to set or get their state at
runtime, or trigger other functionality, which can be called in a thread-safe
manner through the flow graph.</p>
<h2 id="basic-block">Basic Block</h2>
<pre class="language-zig"><code class="language-zig"><span class="token keyword">const</span> radio <span class="token operator">=</span> <span class="token builtin">@import</span><span class="token punctuation">(</span><span class="token string">"radio"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">pub</span> <span class="token keyword">const</span> <span class="token class-name">MultiplyBlock</span> <span class="token operator">=</span> <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    block<span class="token punctuation">:</span> <span class="token class-name">radio<span class="token punctuation">.</span>Block</span><span class="token punctuation">,</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token class-name">MultiplyBlock</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">.</span><span class="token punctuation">{</span> <span class="token punctuation">.</span>block <span class="token operator">=</span> radio<span class="token punctuation">.</span>Block<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token builtin">@This</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">process</span><span class="token punctuation">(</span>_<span class="token punctuation">:</span> <span class="token class-name"><span class="token operator">*</span>MultiplyBlock</span><span class="token punctuation">,</span> x<span class="token punctuation">:</span> <span class="token class-name"><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">const</span> <span class="token builtin-type keyword">f32</span></span><span class="token punctuation">,</span> y<span class="token punctuation">:</span> <span class="token class-name"><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">const</span> <span class="token builtin-type keyword">f32</span></span><span class="token punctuation">,</span> z<span class="token punctuation">:</span> <span class="token class-name"><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin-type keyword">f32</span></span><span class="token punctuation">)</span> <span class="token class-name"><span class="token operator">!</span>radio<span class="token punctuation">.</span>ProcessResult</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token number">0</span><span class="token operator">..</span><span class="token punctuation">)</span> <span class="token operator">|</span>_<span class="token punctuation">,</span> i<span class="token operator">|</span> <span class="token punctuation">{</span>
            z<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> x<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">*</span> y<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> radio<span class="token punctuation">.</span>ProcessResult<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token class-name"><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token builtin-type keyword">usize</span></span><span class="token punctuation">{</span> x<span class="token punctuation">.</span>len<span class="token punctuation">,</span> x<span class="token punctuation">.</span>len <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token class-name"><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token builtin-type keyword">usize</span></span><span class="token punctuation">{</span>x<span class="token punctuation">.</span>len<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre>
<p>At a minimum, a ZigRadio block requires a <code>block: radio.Block</code> field and a
<code>process()</code> function.</p>
<p>The <code>block</code> field holds the relevant information about the block, including its
type signature, port names, implemented hooks, etc., which are required by the
framework to connect and run the block. This field is automatically populated
at compile-time with introspection by calling <code>radio.Block.init(@This())</code>. A
reference to the <code>block</code> field for a particular block instance (e.g.
<code>&amp;multiplyblock.block</code>) is the unique handle used by <code>Flowgraph</code> APIs for
connecting blocks or for calling into them.</p>
<p>The <code>process()</code> function is the main function of the block, called by the
framework repeatedly to convert input samples to output samples. The framework
deduces the input and output ports and their data types from the type signature
of a block's <code>process()</code> function. Arguments of a constant slice type map to
input ports, and those of mutable slice type map to output ports. The
<code>process()</code> function may access and manipulate a block's state through <code>self</code>
argument.</p>
<p>The ZigRadio framework guarantees that <code>process()</code> is only called when there
are a non-zero amount of input samples available across all inputs, and at
least as many output samples available, across all outputs. Blocks that need to
produce more or less output samples relative to input samples are responsible
for managing the available samples, which may require buffering them.</p>
<p>The return value of <code>process()</code> is a <code>ProcessResult</code>, which provides an
accounting of how many samples were consumed and produced, allowing the
framework to acknowledge input samples from upstream blocks and make output
samples available to downstream blocks. This type can be constructed with
<code>ProcessResult.init(consumed: []const usize, produced: []const usize) ProcessResult</code>, where <code>consumed</code> contains the input samples consumed, and
<code>produced</code> contains the output samples produced. The order of inputs in
<code>consumed</code> and outputs in <code>produced</code> follow the order of inputs and outputs in
the <code>process()</code> type signature, respectively.</p>
<p>The <code>process()</code> function may also return an error, which will cause the block
to terminate and the flow graph to collapse.</p>
<h2 id="block-hooks">Block Hooks</h2>
<p>ZigRadio blocks may implement a few optional hooks that are automatically
called by the framework.</p>
<pre class="language-zig"><code class="language-zig"><span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">initialize</span><span class="token punctuation">(</span>self<span class="token punctuation">:</span> <span class="token class-name"><span class="token operator">*</span>Self</span><span class="token punctuation">,</span> allocator<span class="token punctuation">:</span> <span class="token class-name">std<span class="token punctuation">.</span>mem<span class="token punctuation">.</span>Allocator</span><span class="token punctuation">)</span> <span class="token class-name"><span class="token operator">!</span><span class="token builtin-type keyword">void</span></span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span></code></pre>
<p>The <code>initialize()</code> hook is used for memory allocation, I/O initialization, and
sample rate dependent initialization. This function is called by the framework
during flow graph setup, after all blocks are connected and their sample rates
are determined.</p>
<p>The <code>allocator</code> passed to <code>initialize()</code> is the same one that the
<a href="/reference-manual.html#flowgraph"><code>Flowgraph</code></a> was initialized with. Blocks
may call <code>self.block.getRate(comptime T: type) T</code> in <code>initialize()</code> to get
their sample rate in terms of their preferred numeric type (e.g. <code>f32</code>,
<code>usize</code>, etc.).</p>
<p>Blocks may return an error from <code>initialize()</code>, which will cause flow graph
initialization to fail.</p>
<pre class="language-zig"><code class="language-zig"><span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">deinitialize</span><span class="token punctuation">(</span>self<span class="token punctuation">:</span> <span class="token class-name"><span class="token operator">*</span>Self</span><span class="token punctuation">,</span> allocator<span class="token punctuation">:</span> <span class="token class-name">std<span class="token punctuation">.</span>mem<span class="token punctuation">.</span>Allocator</span><span class="token punctuation">)</span> <span class="token class-name"><span class="token builtin-type keyword">void</span></span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span></code></pre>
<p>The <code>deinitialize()</code> hook is used for memory deallocation, I/O
deinitialization, and other deinitialization. The function is called by the
framework on flow graph teardown. The <code>allocator</code> passed to <code>deinitialize()</code> is
the same as the one passed to <code>initialize()</code>, for convenience.</p>
<pre class="language-zig"><code class="language-zig"><span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">setRate</span><span class="token punctuation">(</span>self<span class="token punctuation">:</span> <span class="token class-name"><span class="token operator">*</span>Self</span><span class="token punctuation">,</span> upstream_rate<span class="token punctuation">:</span> <span class="token class-name"><span class="token builtin-type keyword">f64</span></span><span class="token punctuation">)</span> <span class="token class-name"><span class="token operator">!</span><span class="token builtin-type keyword">f64</span></span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span></code></pre>
<p>The <code>setRate()</code> hook is used to override the block's sample rate. By default,
blocks inherit the sample rate of the upstream block connected to their first
input port. Blocks that produce samples at a different sample rate from their
inputs (e.g. downsamplers, upsamplers, etc.), may implement their own
<code>setRate()</code> which returns the modified sample rate. The upstream rate is passed
in the <code>upstream_rate</code> argument.</p>
<p>Blocks may return an error from <code>setRate()</code>, which will cause flow graph
initialization to fail.</p>
<h2 id="data-types">Data Types</h2>
<p>ZigRadio blocks use native Zig types for their input and output ports. Common
data types include:</p>
<ul>
<li><code>std.math.Complex(f32)</code>, for complex-valued samples</li>
<li><code>f32</code>, for real-valued samples</li>
<li><code>u8</code>, for byte samples</li>
<li><code>u1</code>, for bit samples</li>
</ul>
<p>Blocks may also use arbitrary <code>struct</code> and <code>union</code> types for inputs and
outputs, like any other type. Custom types must implement the <code>typeName() []const u8</code> getter for error reporting and debug logging by the framework.</p>
<h2 id="parametric-types">Parametric Types</h2>
<p>Blocks can accept parametric types in the typical fashion for Zig: with a
function that accepts a comptime type and returns a structure parameterized by
that type.</p>
<pre class="language-zig"><code class="language-zig"><span class="token keyword">const</span> radio <span class="token operator">=</span> <span class="token builtin">@import</span><span class="token punctuation">(</span><span class="token string">"radio"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">MultiplyBlock</span><span class="token punctuation">(</span><span class="token keyword">comptime</span> T<span class="token punctuation">:</span> <span class="token class-name"><span class="token builtin-type keyword">type</span></span><span class="token punctuation">)</span> <span class="token class-name"><span class="token builtin-type keyword">type</span></span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">struct</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> Self <span class="token operator">=</span> <span class="token builtin">@This</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        block<span class="token punctuation">:</span> <span class="token class-name">radio<span class="token punctuation">.</span>Block</span><span class="token punctuation">,</span>

        <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token class-name">Self</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token punctuation">.</span><span class="token punctuation">{</span> <span class="token punctuation">.</span>block <span class="token operator">=</span> radio<span class="token punctuation">.</span>Block<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token builtin">@This</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">process</span><span class="token punctuation">(</span>_<span class="token punctuation">:</span> <span class="token class-name"><span class="token operator">*</span>Self</span><span class="token punctuation">,</span> x<span class="token punctuation">:</span> <span class="token class-name"><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">const</span> T</span><span class="token punctuation">,</span> y<span class="token punctuation">:</span> <span class="token class-name"><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">const</span> T</span><span class="token punctuation">,</span> z<span class="token punctuation">:</span> <span class="token class-name"><span class="token punctuation">[</span><span class="token punctuation">]</span>T</span><span class="token punctuation">)</span> <span class="token class-name"><span class="token operator">!</span>radio<span class="token punctuation">.</span>ProcessResult</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token number">0</span><span class="token operator">..</span><span class="token punctuation">)</span> <span class="token operator">|</span>_<span class="token punctuation">,</span> i<span class="token operator">|</span> <span class="token punctuation">{</span>
                z<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> x<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">*</span> y<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">return</span> radio<span class="token punctuation">.</span>ProcessResult<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token class-name"><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token builtin-type keyword">usize</span></span><span class="token punctuation">{</span> x<span class="token punctuation">.</span>len<span class="token punctuation">,</span> x<span class="token punctuation">.</span>len <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token class-name"><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token builtin-type keyword">usize</span></span><span class="token punctuation">{</span>x<span class="token punctuation">.</span>len<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>In this case, <code>MultiplyBlock</code> is made parametric by accepting a comptime type
<code>T</code> that supports the multiply operator, which is most numeric types. This
<code>MultiplyBlock</code> can be instantiated as <code>MultiplyBlock(f32)</code>,
<code>MultiplyBlock(u32)</code>, etc.</p>
<h2 id="special-types">Special Types</h2>
<p>Custom types that need resource management, e.g. memory allocation and
deallocation, require the reference counted wrapper type, <code>RefCounted(T)</code>. This
wrapper type calls <code>.init(...)</code> on the underlying type once on creation, and
<code>.deinit()</code> on the underlying type when its reference count has decremented to
zero.</p>
<p>This allows blocks to create dynamic samples (e.g. samples with memory or other
resource management) that are initialized once, propagated to multiple
downstream blocks, and then finally deinitialized after being processed by the
final block.</p>
<pre class="language-zig"><code class="language-zig"><span class="token keyword">const</span> std <span class="token operator">=</span> <span class="token builtin">@import</span><span class="token punctuation">(</span><span class="token string">"std"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> radio <span class="token operator">=</span> <span class="token builtin">@import</span><span class="token punctuation">(</span><span class="token string">"radio"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">pub</span> <span class="token keyword">const</span> <span class="token class-name">MyPacket</span> <span class="token operator">=</span> <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    src<span class="token punctuation">:</span> <span class="token class-name"><span class="token builtin-type keyword">u32</span></span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
    dst<span class="token punctuation">:</span> <span class="token class-name"><span class="token builtin-type keyword">u32</span></span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
    payload<span class="token punctuation">:</span> <span class="token class-name"><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin-type keyword">u8</span></span> <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token punctuation">.</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>

    allocator<span class="token punctuation">:</span> <span class="token class-name">std<span class="token punctuation">.</span>mem<span class="token punctuation">.</span>Allocatorr</span><span class="token punctuation">,</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">init</span><span class="token punctuation">(</span>allocator<span class="token punctuation">:</span> <span class="token class-name">std<span class="token punctuation">.</span>mem<span class="token punctuation">.</span>Allocator</span><span class="token punctuation">)</span> <span class="token class-name">MyPacket</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">.</span><span class="token punctuation">{</span> <span class="token punctuation">.</span>allocator <span class="token operator">=</span> allocator <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">deinit</span><span class="token punctuation">(</span>self<span class="token punctuation">:</span> <span class="token class-name"><span class="token operator">*</span>MyPacket</span><span class="token punctuation">)</span> <span class="token class-name"><span class="token builtin-type keyword">void</span></span> <span class="token punctuation">{</span>
        self<span class="token punctuation">.</span>allocator<span class="token punctuation">.</span><span class="token function">free</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>payload<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">typeName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token class-name"><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">const</span> <span class="token builtin-type keyword">u8</span></span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">"MyPacket"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre>
<p>In this example, <code>MyPacket</code> has a dynamically allocated <code>payload</code> field. A block might produce
a <code>RefCounted(MyPacket)</code> as in the example below:</p>
<pre class="language-zig"><code class="language-zig"><span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">process</span><span class="token punctuation">(</span>self<span class="token punctuation">:</span> <span class="token class-name"><span class="token operator">*</span>MyPacketDecoderBlock</span><span class="token punctuation">,</span> x<span class="token punctuation">:</span> <span class="token class-name"><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">const</span> u1</span><span class="token punctuation">,</span> z<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">RefCounted</span><span class="token punctuation">(</span>MyPacket<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token class-name"><span class="token operator">!</span>ProcessResult</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>
    z<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">RefCounted</span><span class="token punctuation">(</span>MyPacket<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>allocator<span class="token punctuation">)</span><span class="token punctuation">;</span>
    z<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>value<span class="token punctuation">.</span>src <span class="token operator">=</span> <span class="token operator">...</span><span class="token punctuation">;</span>
    z<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>value<span class="token punctuation">.</span>dst <span class="token operator">=</span> <span class="token operator">...</span><span class="token punctuation">;</span>
    z<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>value<span class="token punctuation">.</span>payload <span class="token operator">=</span> <span class="token keyword">try</span> self<span class="token punctuation">.</span>allocator<span class="token punctuation">.</span><span class="token function">dupe</span><span class="token punctuation">(</span><span class="token builtin-type keyword">u8</span><span class="token punctuation">,</span> <span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">...</span>
    <span class="token keyword">return</span> ProcessResult<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token class-name"><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token builtin-type keyword">usize</span></span><span class="token punctuation">{</span>i<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token class-name"><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token builtin-type keyword">usize</span></span><span class="token punctuation">{</span>j<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<h2 id="asynchronous-control">Asynchronous Control</h2>
<p>Blocks can provide arbitrary functions to access or modify their state at
runtime. These are normal functions, which are run exclusively of <code>process()</code>
by the block runner thread, and thus require no special locking.</p>
<pre class="language-zig"><code class="language-zig"><span class="token keyword">const</span> radio <span class="token operator">=</span> <span class="token builtin">@import</span><span class="token punctuation">(</span><span class="token string">"radio"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">pub</span> <span class="token keyword">const</span> <span class="token class-name">MultiplyConstantBlock</span> <span class="token operator">=</span> <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    block<span class="token punctuation">:</span> <span class="token class-name">radio<span class="token punctuation">.</span>Block</span><span class="token punctuation">,</span>
    constant<span class="token punctuation">:</span> <span class="token class-name"><span class="token builtin-type keyword">f32</span></span><span class="token punctuation">,</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">init</span><span class="token punctuation">(</span>constant<span class="token punctuation">:</span> <span class="token class-name"><span class="token builtin-type keyword">f32</span></span><span class="token punctuation">)</span> <span class="token class-name">MultiplyConstantBlock</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">.</span><span class="token punctuation">{</span> <span class="token punctuation">.</span>block <span class="token operator">=</span> radio<span class="token punctuation">.</span>Block<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token builtin">@This</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">.</span>constant <span class="token operator">=</span> constant <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">process</span><span class="token punctuation">(</span>self<span class="token punctuation">:</span> <span class="token class-name"><span class="token operator">*</span>MultiplyConstantBlock</span><span class="token punctuation">,</span> x<span class="token punctuation">:</span> <span class="token class-name"><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">const</span> <span class="token builtin-type keyword">f32</span></span><span class="token punctuation">,</span> z<span class="token punctuation">:</span> <span class="token class-name"><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin-type keyword">f32</span></span><span class="token punctuation">)</span> <span class="token class-name"><span class="token operator">!</span>radio<span class="token punctuation">.</span>ProcessResult</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token number">0</span><span class="token operator">..</span><span class="token punctuation">)</span> <span class="token operator">|</span>_<span class="token punctuation">,</span> i<span class="token operator">|</span> <span class="token punctuation">{</span>
            z<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> x<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">*</span> self<span class="token punctuation">.</span>constant<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> radio<span class="token punctuation">.</span>ProcessResult<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token class-name"><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token builtin-type keyword">usize</span></span><span class="token punctuation">{</span>x<span class="token punctuation">.</span>len<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token class-name"><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token builtin-type keyword">usize</span></span><span class="token punctuation">{</span>x<span class="token punctuation">.</span>len<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">setConstant</span><span class="token punctuation">(</span>self<span class="token punctuation">:</span> <span class="token class-name"><span class="token operator">*</span>MultiplyConstantBlock</span><span class="token punctuation">,</span> constant<span class="token punctuation">:</span> <span class="token class-name"><span class="token builtin-type keyword">f32</span></span><span class="token punctuation">)</span> <span class="token class-name"><span class="token operator">!</span><span class="token builtin-type keyword">void</span></span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>constant <span class="token operator">></span> <span class="token number">9000</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">error</span><span class="token punctuation">.</span>OutOfBounds<span class="token punctuation">;</span>
        self<span class="token punctuation">.</span>constant <span class="token operator">=</span> constant<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">getConstant</span><span class="token punctuation">(</span>self<span class="token punctuation">:</span> <span class="token class-name"><span class="token operator">*</span>MultiplyConstantBlock</span><span class="token punctuation">)</span> <span class="token class-name"><span class="token builtin-type keyword">f32</span></span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>constant<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre>
<p>This block exposes a <code>setConstant()</code> function to update its constant, and a
<code>getConstant()</code> function to return it. These block functions can be called in a
thread-safe manner through the flow graph with <code>try flowgraph.call(&amp;multiplyconstant.block, MultiplyConstantBlock.setConstant, .{123});</code> and <code>const constant = try flowgraph.call(&amp;multiplyconstant.block, MultiplyConstantBlock.getConstant, .{});</code>.</p>
<h2 id="composite-blocks">Composite Blocks</h2>
<p>Composite blocks are a composition of blocks with internal connectivity
and input/output ports at their boundary.</p>
<pre class="language-zig"><code class="language-zig"><span class="token keyword">const</span> radio <span class="token operator">=</span> <span class="token builtin">@import</span><span class="token punctuation">(</span><span class="token string">"radio"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">pub</span> <span class="token keyword">const</span> <span class="token class-name">MultiplyConstantAndSquareBlock</span> <span class="token operator">=</span> <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    block<span class="token punctuation">:</span> <span class="token class-name">radio<span class="token punctuation">.</span>CompositeBlock</span><span class="token punctuation">,</span>
    b1<span class="token punctuation">:</span> <span class="token class-name">radio<span class="token punctuation">.</span>blocks<span class="token punctuation">.</span>MultiplyConstantBlock</span><span class="token punctuation">,</span>
    b2<span class="token punctuation">:</span> <span class="token class-name">radio<span class="token punctuation">.</span>blocks<span class="token punctuation">.</span>MultiplyBlock</span><span class="token punctuation">,</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">init</span><span class="token punctuation">(</span>constant<span class="token punctuation">:</span> <span class="token class-name"><span class="token builtin-type keyword">f32</span></span><span class="token punctuation">)</span> <span class="token class-name">MultiplyConstantAndSquareBlock</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">.</span><span class="token punctuation">{</span>
            <span class="token punctuation">.</span>block <span class="token operator">=</span> radio<span class="token punctuation">.</span>CompositeBlock<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token builtin">@This</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token punctuation">.</span><span class="token punctuation">{</span><span class="token string">"in1"</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token punctuation">.</span><span class="token punctuation">{</span><span class="token string">"out1"</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">.</span>b1 <span class="token operator">=</span> radio<span class="token punctuation">.</span>blocks<span class="token punctuation">.</span>MultiplyConstantBlock<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>constant<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">.</span>b2 <span class="token operator">=</span> radio<span class="token punctuation">.</span>blocks<span class="token punctuation">.</span>MultiplyBlock<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">connect</span><span class="token punctuation">(</span>self<span class="token punctuation">:</span> <span class="token class-name"><span class="token operator">*</span>MultiplyConstantAndSquareBlock</span><span class="token punctuation">,</span> flowgraph<span class="token punctuation">:</span> <span class="token class-name"><span class="token operator">*</span>radio<span class="token punctuation">.</span>Flowgraph</span><span class="token punctuation">)</span> <span class="token class-name"><span class="token operator">!</span><span class="token builtin-type keyword">void</span></span> <span class="token punctuation">{</span>
        <span class="token comment">// Internal connections</span>
        <span class="token keyword">try</span> flowgraph<span class="token punctuation">.</span><span class="token function">connectPort</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>self<span class="token punctuation">.</span>b1<span class="token punctuation">.</span>block<span class="token punctuation">,</span> <span class="token string">"out1"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>self<span class="token punctuation">.</span>b2<span class="token punctuation">.</span>block<span class="token punctuation">,</span> <span class="token string">"in1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> flowgraph<span class="token punctuation">.</span><span class="token function">connectPort</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>self<span class="token punctuation">.</span>b1<span class="token punctuation">.</span>block<span class="token punctuation">,</span> <span class="token string">"out1"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>self<span class="token punctuation">.</span>b2<span class="token punctuation">.</span>block<span class="token punctuation">,</span> <span class="token string">"in2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Alias inputs and outputs</span>
        <span class="token keyword">try</span> flowgraph<span class="token punctuation">.</span><span class="token function">alias</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>self<span class="token punctuation">.</span>block<span class="token punctuation">,</span> <span class="token string">"in1"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>self<span class="token punctuation">.</span>b1<span class="token punctuation">.</span>block<span class="token punctuation">,</span> <span class="token string">"in1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> flowgraph<span class="token punctuation">.</span><span class="token function">alias</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>self<span class="token punctuation">.</span>block<span class="token punctuation">,</span> <span class="token string">"out1"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>self<span class="token punctuation">.</span>b2<span class="token punctuation">.</span>block<span class="token punctuation">,</span> <span class="token string">"out1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre>
<p>At a minimum, a composite block requires a <code>block: radio.CompositeBlock</code> field
and a <code>connect()</code> function.</p>
<p>The <code>block</code> field holds the relevant information about the composite block,
including its input and output port names, implemented hooks, etc., which are
required by the framework to connect the composition. This field is
automatically populated at compile-time by calling
<code>radio.CompositeBlock.init(@This(), &amp;.{ inputs... }, &amp;.{ outputs... })</code>, where
inputs and outputs are the names of the input and output ports, respectively.</p>
<p>The <code>connect()</code> function is responsible for making internal connections and
defining the boundary ports of the composition. These connections are stored
within the parent flow graph. Within <code>connect()</code>, the ordinary flow graph
<code>connect()</code> and <code>connectPort()</code> functions are used to make internal block
connections, while the flow graph <code>alias()</code> function is used to alias a
composite block's input or output port to an internal block's input or output
port.</p>
<p>The example above illustrates a composition of <code>MultiplyConstantBlock</code> and
<code>MultiplyBlock</code> to multiply a signal by a constant and then square it.</p>
<p>Composite blocks may also expose their own functions for asynchronous control.
However, they must call internal blocks through the provided <code>Flowgraph</code>
argument for thread safety:</p>
<pre class="language-zig"><code class="language-zig"><span class="token keyword">pub</span> <span class="token keyword">const</span> <span class="token class-name">MultiplyConstantAndSquareBlock</span> <span class="token operator">=</span> <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">setConstant</span><span class="token punctuation">(</span>self<span class="token punctuation">:</span> <span class="token class-name"><span class="token operator">*</span>MultiplyConstantAndSquareBlock</span><span class="token punctuation">,</span> flowgraph<span class="token punctuation">:</span> <span class="token class-name"><span class="token operator">*</span>Flowgraph</span><span class="token punctuation">,</span> constant<span class="token punctuation">:</span> <span class="token class-name"><span class="token builtin-type keyword">f32</span></span><span class="token punctuation">)</span> <span class="token class-name"><span class="token operator">!</span><span class="token builtin-type keyword">void</span></span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> flowgraph<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>self<span class="token punctuation">.</span>b1<span class="token punctuation">.</span>block<span class="token punctuation">,</span> MultiplyConstantBlock<span class="token punctuation">.</span>setConstant<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">{</span>constant<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre>
<p>This composite block function can be called in a thread-safe manner through a
flow graph with <code>try top.call(&amp;multiplyconstantandsquare.block, MultiplyConstantAndSquareBlock.setConstant, .{123});</code>.</p>

      </div>
    </div>
  </body>
</html>
