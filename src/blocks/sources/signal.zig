const std = @import("std");

const Block = @import("../../radio.zig").Block;
const ProcessResult = @import("../../radio.zig").ProcessResult;

////////////////////////////////////////////////////////////////////////////////
// Signal Source
////////////////////////////////////////////////////////////////////////////////

pub const SignalSource = struct {
    // Supported waveforms
    pub const WaveformFunction = enum {
        Cosine,
        Sine,
        Square,
        Triangle,
        Sawtooth,
        Constant,
    };

    // Options
    pub const Options = struct {
        amplitude: f32 = 1.0,
        offset: f32 = 0,
        phase: f32 = 0,
    };

    block: Block,

    // Configuration
    waveform: WaveformFunction,
    options: Options,
    frequency: f32,
    rate: f64,

    // State
    process_fn: *const fn (self: *SignalSource, z: []f32) anyerror!ProcessResult = undefined,
    phase: f32 = 0,
    omega: f32 = 0,

    pub fn init(waveform: WaveformFunction, frequency: f32, rate: f64, options: Options) SignalSource {
        return .{ .block = Block.init(@This()), .waveform = waveform, .frequency = frequency, .rate = rate, .options = options };
    }

    pub fn setRate(self: *SignalSource, _: f64) !f64 {
        return self.rate;
    }

    pub fn initialize(self: *SignalSource, _: std.mem.Allocator) !void {
        self.process_fn = switch (self.waveform) {
            .Cosine => _processCosine,
            .Sine => _processSine,
            .Square => _processSquare,
            .Triangle => _processTriangle,
            .Sawtooth => _processSawtooth,
            .Constant => _processConstant,
        };

        self.phase = self.options.phase;
        self.omega = 2 * std.math.pi * (self.frequency / try self.block.getRate(f32));
    }

    pub fn _processCosine(self: *SignalSource, z: []f32) !ProcessResult {
        for (z) |*e| {
            e.* = std.math.cos(self.phase) * self.options.amplitude + self.options.offset;
            self.phase += self.omega;
            self.phase = if (self.phase >= 2 * std.math.pi) self.phase - 2 * std.math.pi else self.phase;
        }

        return ProcessResult.init(&[0]usize{}, &[1]usize{z.len});
    }

    pub fn _processSine(self: *SignalSource, z: []f32) !ProcessResult {
        for (z) |*e| {
            e.* = std.math.sin(self.phase) * self.options.amplitude + self.options.offset;
            self.phase += self.omega;
            self.phase = if (self.phase >= 2 * std.math.pi) self.phase - 2 * std.math.pi else self.phase;
        }

        return ProcessResult.init(&[0]usize{}, &[1]usize{z.len});
    }

    pub fn _processSquare(self: *SignalSource, z: []f32) !ProcessResult {
        for (z) |*e| {
            if (self.phase < std.math.pi) {
                e.* = self.options.amplitude + self.options.offset;
            } else {
                e.* = -1 * self.options.amplitude + self.options.offset;
            }
            self.phase += self.omega;
            self.phase = if (self.phase >= 2 * std.math.pi) self.phase - 2 * std.math.pi else self.phase;
        }

        return ProcessResult.init(&[0]usize{}, &[1]usize{z.len});
    }

    pub fn _processTriangle(self: *SignalSource, z: []f32) !ProcessResult {
        for (z) |*e| {
            if (self.phase < std.math.pi) {
                e.* = (1.0 - (2.0 / std.math.pi) * self.phase) * self.options.amplitude + self.options.offset;
            } else {
                e.* = (-1.0 + (2.0 / std.math.pi) * (self.phase - std.math.pi)) * self.options.amplitude + self.options.offset;
            }
            self.phase += self.omega;
            self.phase = if (self.phase >= 2 * std.math.pi) self.phase - 2 * std.math.pi else self.phase;
        }

        return ProcessResult.init(&[0]usize{}, &[1]usize{z.len});
    }

    pub fn _processSawtooth(self: *SignalSource, z: []f32) !ProcessResult {
        for (z) |*e| {
            e.* = (-1.0 + (1.0 / std.math.pi) * self.phase) * self.options.amplitude + self.options.offset;
            self.phase += self.omega;
            self.phase = if (self.phase >= 2 * std.math.pi) self.phase - 2 * std.math.pi else self.phase;
        }

        return ProcessResult.init(&[0]usize{}, &[1]usize{z.len});
    }

    pub fn _processConstant(self: *SignalSource, z: []f32) !ProcessResult {
        for (z) |*e| {
            e.* = self.options.amplitude;
        }

        return ProcessResult.init(&[0]usize{}, &[1]usize{z.len});
    }

    pub fn process(self: *SignalSource, z: []f32) !ProcessResult {
        return self.process_fn(self, z);
    }
};

////////////////////////////////////////////////////////////////////////////////
// Tests
////////////////////////////////////////////////////////////////////////////////

const BlockTester = @import("radio").testing.BlockTester;

test "SignalSource" {
    // Cosine frequency 50, sample rate 1000, ampltiude 1.00, phase 0.0000, offset 0.00
    {
        var block = SignalSource.init(SignalSource.WaveformFunction.Cosine, 50, 1000.0, .{ .amplitude = 1.0, .offset = 0.0, .phase = 0.0 });
        var tester = BlockTester.init(&block.block, 1.5e-5);
        try tester.checkSource(&[1]type{f32}, .{&[64]f32{ 1.00000000, 0.95105654, 0.80901700, 0.58778524, 0.30901700, 0.00000000, -0.30901700, -0.58778524, -0.80901700, -0.95105654, -1.00000000, -0.95105654, -0.80901700, -0.58778524, -0.30901700, -0.00000000, 0.30901700, 0.58778524, 0.80901700, 0.95105654, 1.00000000, 0.95105654, 0.80901700, 0.58778524, 0.30901700, 0.00000000, -0.30901700, -0.58778524, -0.80901700, -0.95105654, -1.00000000, -0.95105654, -0.80901700, -0.58778524, -0.30901700, -0.00000000, 0.30901700, 0.58778524, 0.80901700, 0.95105654, 1.00000000, 0.95105654, 0.80901700, 0.58778524, 0.30901700, 0.00000000, -0.30901700, -0.58778524, -0.80901700, -0.95105654, -1.00000000, -0.95105654, -0.80901700, -0.58778524, -0.30901700, -0.00000000, 0.30901700, 0.58778524, 0.80901700, 0.95105654, 1.00000000, 0.95105654, 0.80901700, 0.58778524 }});
    }

    // Cosine frequency 100, sample rate 1000, ampltiude 2.50, phase 0.7854, offset -0.50
    {
        var block = SignalSource.init(SignalSource.WaveformFunction.Cosine, 100, 1000.0, .{ .amplitude = 2.5, .offset = -0.5, .phase = 0.7853981633974483 });
        var tester = BlockTester.init(&block.block, 1.5e-5);
        try tester.checkSource(&[1]type{f32}, .{&[64]f32{ 1.26776695, -0.10891384, -1.63497627, -2.72751641, -2.96922088, -2.26776695, -0.89108616, 0.63497627, 1.72751629, 1.96922088, 1.26776695, -0.10891384, -1.63497627, -2.72751641, -2.96922088, -2.26776695, -0.89108616, 0.63497627, 1.72751629, 1.96922088, 1.26776695, -0.10891384, -1.63497627, -2.72751641, -2.96922088, -2.26776695, -0.89108616, 0.63497627, 1.72751629, 1.96922088, 1.26776695, -0.10891384, -1.63497627, -2.72751641, -2.96922088, -2.26776695, -0.89108616, 0.63497627, 1.72751629, 1.96922088, 1.26776695, -0.10891384, -1.63497627, -2.72751641, -2.96922088, -2.26776695, -0.89108616, 0.63497627, 1.72751629, 1.96922088, 1.26776695, -0.10891384, -1.63497627, -2.72751641, -2.96922088, -2.26776695, -0.89108616, 0.63497627, 1.72751629, 1.96922088, 1.26776695, -0.10891384, -1.63497627, -2.72751641 }});
    }

    // Sine frequency 50, sample rate 1000, ampltiude 1.00, phase 0.0000, offset 0.00
    {
        var block = SignalSource.init(SignalSource.WaveformFunction.Sine, 50, 1000.0, .{ .amplitude = 1.0, .offset = 0.0, .phase = 0.0 });
        var tester = BlockTester.init(&block.block, 1.5e-5);
        try tester.checkSource(&[1]type{f32}, .{&[64]f32{ 0.00000000, 0.30901700, 0.58778524, 0.80901700, 0.95105654, 1.00000000, 0.95105654, 0.80901700, 0.58778524, 0.30901700, 0.00000000, -0.30901700, -0.58778524, -0.80901700, -0.95105654, -1.00000000, -0.95105654, -0.80901700, -0.58778524, -0.30901700, -0.00000000, 0.30901700, 0.58778524, 0.80901700, 0.95105654, 1.00000000, 0.95105654, 0.80901700, 0.58778524, 0.30901700, 0.00000000, -0.30901700, -0.58778524, -0.80901700, -0.95105654, -1.00000000, -0.95105654, -0.80901700, -0.58778524, -0.30901700, -0.00000000, 0.30901700, 0.58778524, 0.80901700, 0.95105654, 1.00000000, 0.95105654, 0.80901700, 0.58778524, 0.30901700, 0.00000000, -0.30901700, -0.58778524, -0.80901700, -0.95105654, -1.00000000, -0.95105654, -0.80901700, -0.58778524, -0.30901700, -0.00000000, 0.30901700, 0.58778524, 0.80901700 }});
    }

    // Sine frequency 100, sample rate 1000, ampltiude 2.50, phase 0.7854, offset -0.50
    {
        var block = SignalSource.init(SignalSource.WaveformFunction.Sine, 100, 1000.0, .{ .amplitude = 2.5, .offset = -0.5, .phase = 0.7853981633974483 });
        var tester = BlockTester.init(&block.block, 1.5e-5);
        try tester.checkSource(&[1]type{f32}, .{&[64]f32{ 1.26776695, 1.96922088, 1.72751629, 0.63497627, -0.89108616, -2.26776695, -2.96922088, -2.72751641, -1.63497627, -0.10891384, 1.26776695, 1.96922088, 1.72751629, 0.63497627, -0.89108616, -2.26776695, -2.96922088, -2.72751641, -1.63497627, -0.10891384, 1.26776695, 1.96922088, 1.72751629, 0.63497627, -0.89108616, -2.26776695, -2.96922088, -2.72751641, -1.63497627, -0.10891384, 1.26776695, 1.96922088, 1.72751629, 0.63497627, -0.89108616, -2.26776695, -2.96922088, -2.72751641, -1.63497627, -0.10891384, 1.26776695, 1.96922088, 1.72751629, 0.63497627, -0.89108616, -2.26776695, -2.96922088, -2.72751641, -1.63497627, -0.10891384, 1.26776695, 1.96922088, 1.72751629, 0.63497627, -0.89108616, -2.26776695, -2.96922088, -2.72751641, -1.63497627, -0.10891384, 1.26776695, 1.96922088, 1.72751629, 0.63497627 }});
    }

    // Square frequency 50, sample rate 1000, ampltiude 1.00, phase 0.0000, offset 0.00
    {
        var block = SignalSource.init(SignalSource.WaveformFunction.Square, 50, 1000.0, .{ .amplitude = 1.0, .offset = 0.0, .phase = 0.0 });
        var tester = BlockTester.init(&block.block, 1.5e-5);
        try tester.checkSource(&[1]type{f32}, .{&[64]f32{ 1.00000000, 1.00000000, 1.00000000, 1.00000000, 1.00000000, 1.00000000, 1.00000000, 1.00000000, 1.00000000, 1.00000000, -1.00000000, -1.00000000, -1.00000000, -1.00000000, -1.00000000, -1.00000000, -1.00000000, -1.00000000, -1.00000000, -1.00000000, 1.00000000, 1.00000000, 1.00000000, 1.00000000, 1.00000000, 1.00000000, 1.00000000, 1.00000000, 1.00000000, 1.00000000, -1.00000000, -1.00000000, -1.00000000, -1.00000000, -1.00000000, -1.00000000, -1.00000000, -1.00000000, -1.00000000, -1.00000000, 1.00000000, 1.00000000, 1.00000000, 1.00000000, 1.00000000, 1.00000000, 1.00000000, 1.00000000, 1.00000000, 1.00000000, -1.00000000, -1.00000000, -1.00000000, -1.00000000, -1.00000000, -1.00000000, -1.00000000, -1.00000000, -1.00000000, -1.00000000, 1.00000000, 1.00000000, 1.00000000, 1.00000000 }});
    }

    // Square frequency 100, sample rate 1000, ampltiude 2.50, phase 0.7854, offset -0.50
    {
        var block = SignalSource.init(SignalSource.WaveformFunction.Square, 100, 1000.0, .{ .amplitude = 2.5, .offset = -0.5, .phase = 0.7853981633974483 });
        var tester = BlockTester.init(&block.block, 1.5e-5);
        try tester.checkSource(&[1]type{f32}, .{&[64]f32{ 2.00000000, 2.00000000, 2.00000000, 2.00000000, -3.00000000, -3.00000000, -3.00000000, -3.00000000, -3.00000000, 2.00000000, 2.00000000, 2.00000000, 2.00000000, 2.00000000, -3.00000000, -3.00000000, -3.00000000, -3.00000000, -3.00000000, 2.00000000, 2.00000000, 2.00000000, 2.00000000, 2.00000000, -3.00000000, -3.00000000, -3.00000000, -3.00000000, -3.00000000, 2.00000000, 2.00000000, 2.00000000, 2.00000000, 2.00000000, -3.00000000, -3.00000000, -3.00000000, -3.00000000, -3.00000000, 2.00000000, 2.00000000, 2.00000000, 2.00000000, 2.00000000, -3.00000000, -3.00000000, -3.00000000, -3.00000000, -3.00000000, 2.00000000, 2.00000000, 2.00000000, 2.00000000, 2.00000000, -3.00000000, -3.00000000, -3.00000000, -3.00000000, -3.00000000, 2.00000000, 2.00000000, 2.00000000, 2.00000000, 2.00000000 }});
    }

    // Triangle frequency 50, sample rate 1000, ampltiude 1.00, phase 0.0000, offset 0.00
    {
        var block = SignalSource.init(SignalSource.WaveformFunction.Triangle, 50, 1000.0, .{ .amplitude = 1.0, .offset = 0.0, .phase = 0.0 });
        var tester = BlockTester.init(&block.block, 1.5e-5);
        try tester.checkSource(&[1]type{f32}, .{&[64]f32{ 1.00000000, 0.80000001, 0.60000002, 0.40000001, 0.20000000, 0.00000000, -0.20000000, -0.40000001, -0.60000002, -0.80000001, -1.00000000, -0.80000001, -0.60000002, -0.40000001, -0.20000000, 0.00000000, 0.20000000, 0.40000001, 0.60000002, 0.80000001, 1.00000000, 0.80000001, 0.60000002, 0.40000001, 0.20000000, 0.00000000, -0.20000000, -0.40000001, -0.60000002, -0.80000001, -1.00000000, -0.80000001, -0.60000002, -0.40000001, -0.20000000, 0.00000000, 0.20000000, 0.40000001, 0.60000002, 0.80000001, 1.00000000, 0.80000001, 0.60000002, 0.40000001, 0.20000000, 0.00000000, -0.20000000, -0.40000001, -0.60000002, -0.80000001, -1.00000000, -0.80000001, -0.60000002, -0.40000001, -0.20000000, 0.00000000, 0.20000000, 0.40000001, 0.60000002, 0.80000001, 1.00000000, 0.80000001, 0.60000002, 0.40000001 }});
    }

    // Triangle frequency 100, sample rate 1000, ampltiude 2.50, phase 0.7854, offset -0.50
    {
        var block = SignalSource.init(SignalSource.WaveformFunction.Triangle, 100, 1000.0, .{ .amplitude = 2.5, .offset = -0.5, .phase = 0.7853981633974483 });
        var tester = BlockTester.init(&block.block, 1.5e-5);
        try tester.checkSource(&[1]type{f32}, .{&[64]f32{ 0.75000000, -0.25000000, -1.25000000, -2.25000000, -2.75000000, -1.75000000, -0.75000000, 0.25000000, 1.25000000, 1.75000000, 0.75000000, -0.25000000, -1.25000000, -2.25000000, -2.75000000, -1.75000000, -0.75000000, 0.25000000, 1.25000000, 1.75000000, 0.75000000, -0.25000000, -1.25000000, -2.25000000, -2.75000000, -1.75000000, -0.75000000, 0.25000000, 1.25000000, 1.75000000, 0.75000000, -0.25000000, -1.25000000, -2.25000000, -2.75000000, -1.75000000, -0.75000000, 0.25000000, 1.25000000, 1.75000000, 0.75000000, -0.25000000, -1.25000000, -2.25000000, -2.75000000, -1.75000000, -0.75000000, 0.25000000, 1.25000000, 1.75000000, 0.75000000, -0.25000000, -1.25000000, -2.25000000, -2.75000000, -1.75000000, -0.75000000, 0.25000000, 1.25000000, 1.75000000, 0.75000000, -0.25000000, -1.25000000, -2.25000000 }});
    }

    // Sawtooth frequency 50, sample rate 1000, ampltiude 1.00, phase 0.0000, offset 0.00
    {
        var block = SignalSource.init(SignalSource.WaveformFunction.Sawtooth, 50, 1000.0, .{ .amplitude = 1.0, .offset = 0.0, .phase = 0.0 });
        var tester = BlockTester.init(&block.block, 1.5e-5);
        try tester.checkSource(&[1]type{f32}, .{&[64]f32{ -1.00000000, -0.89999998, -0.80000001, -0.69999999, -0.60000002, -0.50000000, -0.40000001, -0.30000001, -0.20000000, -0.10000000, 0.00000000, 0.10000000, 0.20000000, 0.30000001, 0.40000001, 0.50000000, 0.60000002, 0.69999999, 0.80000001, 0.89999998, -1.00000000, -0.89999998, -0.80000001, -0.69999999, -0.60000002, -0.50000000, -0.40000001, -0.30000001, -0.20000000, -0.10000000, 0.00000000, 0.10000000, 0.20000000, 0.30000001, 0.40000001, 0.50000000, 0.60000002, 0.69999999, 0.80000001, 0.89999998, -1.00000000, -0.89999998, -0.80000001, -0.69999999, -0.60000002, -0.50000000, -0.40000001, -0.30000001, -0.20000000, -0.10000000, 0.00000000, 0.10000000, 0.20000000, 0.30000001, 0.40000001, 0.50000000, 0.60000002, 0.69999999, 0.80000001, 0.89999998, -1.00000000, -0.89999998, -0.80000001, -0.69999999 }});
    }

    // Sawtooth frequency 100, sample rate 1000, ampltiude 2.50, phase 0.7854, offset -0.50
    {
        var block = SignalSource.init(SignalSource.WaveformFunction.Sawtooth, 100, 1000.0, .{ .amplitude = 2.5, .offset = -0.5, .phase = 0.7853981633974483 });
        var tester = BlockTester.init(&block.block, 1.5e-5);
        try tester.checkSource(&[1]type{f32}, .{&[64]f32{ -2.37500000, -1.87500000, -1.37500000, -0.87500000, -0.37500000, 0.12500000, 0.62500000, 1.12500000, 1.62500000, -2.87500000, -2.37500000, -1.87500000, -1.37500000, -0.87500000, -0.37500000, 0.12500000, 0.62500000, 1.12500000, 1.62500000, -2.87500000, -2.37500000, -1.87500000, -1.37500000, -0.87500000, -0.37500000, 0.12500000, 0.62500000, 1.12500000, 1.62500000, -2.87500000, -2.37500000, -1.87500000, -1.37500000, -0.87500000, -0.37500000, 0.12500000, 0.62500000, 1.12500000, 1.62500000, -2.87500000, -2.37500000, -1.87500000, -1.37500000, -0.87500000, -0.37500000, 0.12500000, 0.62500000, 1.12500000, 1.62500000, -2.87500000, -2.37500000, -1.87500000, -1.37500000, -0.87500000, -0.37500000, 0.12500000, 0.62500000, 1.12500000, 1.62500000, -2.87500000, -2.37500000, -1.87500000, -1.37500000, -0.87500000 }});
    }

    // Constant frequency 50, sample rate 1000, ampltiude 1.00, phase 0.0000, offset 0.00
    {
        var block = SignalSource.init(SignalSource.WaveformFunction.Constant, 50, 1000.0, .{ .amplitude = 1.0, .offset = 0.0, .phase = 0.0 });
        var tester = BlockTester.init(&block.block, 1.5e-5);
        try tester.checkSource(&[1]type{f32}, .{&[64]f32{ 1.00000000, 1.00000000, 1.00000000, 1.00000000, 1.00000000, 1.00000000, 1.00000000, 1.00000000, 1.00000000, 1.00000000, 1.00000000, 1.00000000, 1.00000000, 1.00000000, 1.00000000, 1.00000000, 1.00000000, 1.00000000, 1.00000000, 1.00000000, 1.00000000, 1.00000000, 1.00000000, 1.00000000, 1.00000000, 1.00000000, 1.00000000, 1.00000000, 1.00000000, 1.00000000, 1.00000000, 1.00000000, 1.00000000, 1.00000000, 1.00000000, 1.00000000, 1.00000000, 1.00000000, 1.00000000, 1.00000000, 1.00000000, 1.00000000, 1.00000000, 1.00000000, 1.00000000, 1.00000000, 1.00000000, 1.00000000, 1.00000000, 1.00000000, 1.00000000, 1.00000000, 1.00000000, 1.00000000, 1.00000000, 1.00000000, 1.00000000, 1.00000000, 1.00000000, 1.00000000, 1.00000000, 1.00000000, 1.00000000, 1.00000000 }});
    }

    // Constant frequency 100, sample rate 1000, ampltiude 2.50, phase 0.7854, offset -0.50
    {
        var block = SignalSource.init(SignalSource.WaveformFunction.Constant, 100, 1000.0, .{ .amplitude = 2.5, .offset = -0.5, .phase = 0.7853981633974483 });
        var tester = BlockTester.init(&block.block, 1.5e-5);
        try tester.checkSource(&[1]type{f32}, .{&[64]f32{ 2.50000000, 2.50000000, 2.50000000, 2.50000000, 2.50000000, 2.50000000, 2.50000000, 2.50000000, 2.50000000, 2.50000000, 2.50000000, 2.50000000, 2.50000000, 2.50000000, 2.50000000, 2.50000000, 2.50000000, 2.50000000, 2.50000000, 2.50000000, 2.50000000, 2.50000000, 2.50000000, 2.50000000, 2.50000000, 2.50000000, 2.50000000, 2.50000000, 2.50000000, 2.50000000, 2.50000000, 2.50000000, 2.50000000, 2.50000000, 2.50000000, 2.50000000, 2.50000000, 2.50000000, 2.50000000, 2.50000000, 2.50000000, 2.50000000, 2.50000000, 2.50000000, 2.50000000, 2.50000000, 2.50000000, 2.50000000, 2.50000000, 2.50000000, 2.50000000, 2.50000000, 2.50000000, 2.50000000, 2.50000000, 2.50000000, 2.50000000, 2.50000000, 2.50000000, 2.50000000, 2.50000000, 2.50000000, 2.50000000, 2.50000000 }});
    }
}
